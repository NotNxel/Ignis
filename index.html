<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JJK: THE HONORED ONE</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', sans-serif; }
        #ui { position: absolute; top: 5%; width: 100%; text-align: center; color: #fff; pointer-events: none; z-index: 10; }
        h1 { font-size: 3.5rem; margin: 0; letter-spacing: 15px; font-weight: 900; background: linear-gradient(to bottom, #fff, #444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #technique-name { font-size: 1.8rem; color: #ff0000; margin-top: 10px; font-weight: bold; letter-spacing: 8px; text-transform: uppercase; text-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
        
        #video-container { position: absolute; bottom: 30px; left: 30px; transform: scaleX(-1); width: 320px; height: 240px; border: 2px solid #555; border-radius: 15px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        #output_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* MULTI-DIRECTIONAL DISMANTLE */
        #slash-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 15; }
        .slash { 
            position: absolute; 
            height: 4px; 
            background: linear-gradient(90deg, transparent, #fff 20%, #ff0000 50%, #fff 80%, transparent); 
            box-shadow: 0 0 25px #f00, 0 0 5px #fff;
            filter: blur(1px);
            animation: slash-anim 0.3s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
        }
        @keyframes slash-anim {
            0% { transform: translate(-50%, -50%) scaleX(0) rotate(var(--r)); opacity: 1; }
            100% { transform: translate(-50%, -50%) scaleX(1.5) rotate(var(--r)); opacity: 0; }
        }
    </style>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } } </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
    <div id="slash-container"></div>
    <div id="ui"><h1>呪術廻戦</h1><div id="technique-name">RESONANCE</div></div>
    <div id="video-container"><video class="input_video"></video><canvas id="output_canvas"></canvas></div>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 100;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 2.5, 0.4, 0.85));

    const COUNT = 35000;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(COUNT * 3), col = new Float32Array(COUNT * 3), siz = new Float32Array(COUNT);
    const tarPos = new Float32Array(COUNT * 3), tarCol = new Float32Array(COUNT * 3), tarSiz = new Float32Array(COUNT);

    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
    geo.setAttribute('size', new THREE.BufferAttribute(siz, 1));

    const points = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.6, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true }));
    scene.add(points);

    // --- STATES ---
    function resetParticles(r,g,b, size=0.4) {
        for(let i=0; i<COUNT; i++) {
            tarCol[i*3]=r; tarCol[i*3+1]=g; tarCol[i*3+2]=b;
            tarSiz[i]=size;
        }
    }

    function spawnMultiSlash() {
        const container = document.getElementById('slash-container');
        for(let i=0; i<3; i++) {
            const s = document.createElement('div');
            s.className = 'slash';
            s.style.left = '50%'; s.style.top = '50%';
            s.style.width = (60 + Math.random()*40) + 'vw';
            s.style.setProperty('--r', Math.random()*360 + 'deg');
            container.appendChild(s);
            setTimeout(() => s.remove(), 300);
        }
        document.body.style.transform = `translate(${(Math.random()-0.5)*20}px, ${(Math.random()-0.5)*20}px)`;
    }

    // --- TRACKING ---
    const video = document.querySelector('.input_video');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

    let currentTech = 'neutral';
    hands.onResults((res) => {
        let detected = 'neutral';
        if(res.multiHandLandmarks.length > 0) {
            const h = res.multiHandLandmarks[0];
            const finger = (tip, pip) => h[tip].y < h[pip].y;
            const d = (a, b) => Math.hypot(h[a].x - h[b].x, h[a].y - h[b].y);

            if(res.multiHandLandmarks.length === 2) detected = 'mahoraga';
            else {
                const index = finger(8, 6), mid = finger(12, 10), ring = finger(16, 14), pinky = finger(20, 18);
                const pinch = d(4, 8) < 0.05;
                const crossed = d(8, 12) < 0.025 && index && mid;

                if(pinch) detected = 'purple';
                else if(crossed) detected = 'void';
                else if(index && mid && ring && pinky) detected = 'shrine';
                else if(index && mid && !ring) detected = 'dismantle';
                else if(index && !mid) detected = 'red';
            }
        }
        if(detected !== currentTech) {
            currentTech = detected;
            document.getElementById('technique-name').innerText = detected === 'neutral' ? "Cursed Energy" : detected;
            if(detected === 'void') { resetParticles(0.5, 0.8, 1, 0.3); }
            if(detected === 'shrine') { resetParticles(1, 0, 0, 0.8); }
            if(detected === 'purple') { resetParticles(0.6, 0, 1, 1.5); }
            if(detected === 'mahoraga') { resetParticles(1, 0.9, 0, 1.2); }
        }
    });

    new Camera(video, {onFrame: async () => {await hands.send({image: video})}, width: 640, height: 480}).start();

    function animate() {
        requestAnimationFrame(animate);
        const pArr = points.geometry.attributes.position.array;
        const cArr = points.geometry.attributes.color.array;
        const sArr = points.geometry.attributes.size.array;
        const t = Date.now() * 0.002;

        for(let i=0; i<COUNT; i++) {
            let tx=0, ty=0, tz=0;
            if(currentTech === 'void') {
                const r = 40 + Math.sin(t+i)*10;
                tx = r * Math.cos(i); ty = r * Math.sin(i); tz = Math.tan(t+i)*10;
            } else if(currentTech === 'shrine') {
                tx = (Math.random()-0.5)*120; ty = -40; tz = (Math.random()-0.5)*120;
            } else if(currentTech === 'purple') {
                const r = 20;
                tx = r * Math.sin(i*0.1) * Math.cos(i); ty = r * Math.sin(i*0.1) * Math.sin(i); tz = r * Math.cos(i*0.1);
            } else if(currentTech === 'dismantle') {
                tx = (Math.random()-0.5)*10; ty = (Math.random()-0.5)*10; tz = (Math.random()-0.5)*10;
                if(Math.random() > 0.9) spawnMultiSlash();
            } else if(currentTech === 'mahoraga') {
                const a = (i*0.2) + t;
                if(i < COUNT*0.3) { tx = 20*Math.cos(a); ty = 50; tz = 20*Math.sin(a); }
                else { tx = (Math.random()-0.5)*40; ty = (Math.random()-0.5)*60; tz = (Math.random()-0.5)*20; }
            } else {
                tx = Math.sin(t + i)*30; ty = Math.cos(t + i*0.5)*30; tz = Math.sin(t*0.5)*20;
                tarCol[i*3]=0; tarCol[i*3+1]=0.4; tarCol[i*3+2]=0.8; tarSiz[i]=0.3;
            }
            
            pArr[i*3] += (tx - pArr[i*3]) * 0.1;
            pArr[i*3+1] += (ty - pArr[i*3+1]) * 0.1;
            pArr[i*3+2] += (tz - pArr[i*3+2]) * 0.1;
            cArr[i*3] += (tarCol[i*3] - cArr[i*3]) * 0.1;
            cArr[i*3+1] += (tarCol[i*3+1] - cArr[i*3+1]) * 0.1;
            cArr[i*3+2] += (tarCol[i*3+2] - cArr[i*3+2]) * 0.1;
            sArr[i] += (tarSiz[i] - sArr[i]) * 0.1;
        }

        points.geometry.attributes.position.needsUpdate = true;
        points.geometry.attributes.color.needsUpdate = true;
        points.geometry.attributes.size.needsUpdate = true;
        if(currentTech !== 'dismantle') document.body.style.transform = 'none';
        composer.render();
    }
    animate();
</script>
</body>
</html>
