<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JJK: THE HONORED ONE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; }
        #ui { position: absolute; top: 5%; width: 100%; text-align: center; color: white; z-index: 10; pointer-events: none; }
        #technique-name { font-size: 3rem; font-weight: 900; letter-spacing: 12px; text-transform: uppercase; text-shadow: 0 0 30px #fff; }
        #video-container { position: absolute; bottom: 20px; left: 20px; width: 220px; height: 160px; border: 1px solid #444; border-radius: 8px; overflow: hidden; transform: scaleX(-1); opacity: 0.5; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .slash { position: absolute; height: 3px; background: white; box-shadow: 0 0 20px red; pointer-events: none; animation: slash-anim 0.2s linear forwards; z-index: 5; }
        @keyframes slash-anim { 0% { transform: translate(-50%, -50%) scaleX(0) rotate(var(--r)); opacity: 1; } 100% { transform: translate(-50%, -50%) scaleX(4) rotate(var(--r)); opacity: 0; } }
    </style>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
    <div id="ui"><div id="technique-name">RESONANCE</div></div>
    <div id="video-container"><video class="input_video"></video></div>

<script type="module">
    import * as THREE from 'three';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.z = 120;
    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const COUNT = 18000;
    const pos = new Float32Array(COUNT * 3), col = new Float32Array(COUNT * 3);
    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
    
    const mat = new THREE.PointsMaterial({ size: 1.2, vertexColors: true, blending: THREE.AdditiveBlending });
    const points = new THREE.Points(geo, mat);
    scene.add(points);

    let currentTech = 'neutral';

    function spawnSlash() {
        const s = document.createElement('div'); s.className = 'slash';
        s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
        s.style.width = '90vw'; s.style.setProperty('--r', Math.random()*360+'deg');
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 200);
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.6 });

    hands.onResults((res) => {
        let tech = 'neutral';
        if(res.multiHandLandmarks.length === 2) {
            tech = 'mahoraga';
        } else if(res.multiHandLandmarks.length === 1) {
            const h = res.multiHandLandmarks[0];
            const up = (i) => h[i].y < h[i-2].y;
            const d = (a, b) => Math.hypot(h[a].x - h[b].x, h[a].y - h[b].y);
            
            const index = up(8), mid = up(12), ring = up(16), pinky = up(20);
            const pinch = d(4, 8) < 0.04;
            const crossed = d(8, 12) < 0.025; 

            if (index && mid && crossed) tech = 'infinite_void';
            else if (pinch) tech = 'purple';
            else if (index && mid && !ring) tech = 'dismantle';
            else if (index && !mid && !ring) tech = 'red';
            else if (index && mid && ring && pinky) tech = 'shrine';
        }

        if(tech !== currentTech) {
            currentTech = tech;
            const ui = document.getElementById('technique-name');
            ui.innerText = tech.replace('_', ' ').toUpperCase();
            
            const colors = {
                'infinite_void': '#fff',
                'purple': '#b0f',
                'red': '#ff3333',
                'dismantle': '#ffffff',
                'shrine': '#ff0000',
                'neutral': '#0af'
            };
            ui.style.color = colors[tech] || '#fff';
        }
    });

    const video = document.querySelector('.input_video');
    new Camera(video, {onFrame: async () => {await hands.send({image: video})}, width: 480, height: 360}).start();

    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.002;
        const pa = points.geometry.attributes.position.array;
        const ca = points.geometry.attributes.color.array;

        for(let i=0; i<COUNT; i++) {
            let tx, ty, tz, r=0, g=0.5, b=1;

            if(currentTech === 'infinite_void') {
                const angle = i * 0.1 + time;
                const radius = (i < COUNT * 0.7) ? 50 : (i/COUNT * 220);
                tx = Math.cos(angle) * radius;
                ty = Math.sin(angle) * radius;
                tz = (i < COUNT * 0.7) ? Math.cos(time) * 40 : Math.sin(time + i)*120;
                r=0.9; g=0.9; b=1;
            } else if(currentTech === 'purple') {
                const r_p = 35 + Math.sin(time*10)*5;
                tx = Math.sin(i)*r_p*Math.cos(time*3); ty = Math.cos(i)*r_p; tz = Math.sin(time*3)*r_p;
                r=0.7; g=0; b=1;
            } else if(currentTech === 'red') {
                tx = Math.cos(i)*15 + (Math.random()-0.5)*20; ty = Math.sin(i)*15 + (Math.random()-0.5)*20; tz = 50 + Math.sin(time*10)*10;
                r=1; g=0.1; b=0.1;
            } else if(currentTech === 'dismantle') {
                tx = (Math.random()-0.5)*25; ty = (Math.random()-0.5)*25; tz = (Math.random()-0.5)*25;
                r=1; g=1; b=1;
                if(Math.random() > 0.92) spawnSlash();
            } else if(currentTech === 'mahoraga') {
                if(i < COUNT*0.8) { 
                    tx = (Math.random()-0.5)*60 * (i/COUNT); ty = (i/COUNT)*190 - 95; tz = Math.sin(i)*30;
                    r=0.8; g=0.8; b=0.8;
                } else { 
                    tx = Math.cos(i+time*6)*40; ty = 85; tz = Math.sin(i+time*6)*40;
                    r=1; g=0.7; b=0;
                }
            } else if(currentTech === 'shrine') {
                tx = (Math.random()-0.5)*140; ty = -70; tz = (Math.random()-0.5)*140;
                r=1; g=0; b=0;
            } else {
                tx = Math.sin(time+i)*35; ty = Math.cos(time+i)*35; tz = Math.sin(time)*15;
            }

            pa[i*3] += (tx - pa[i*3]) * 0.13;
            pa[i*3+1] += (ty - pa[i*3+1]) * 0.13;
            pa[i*3+2] += (tz - pa[i*3+2]) * 0.13;
            ca[i*3] += (r - ca[i*3]) * 0.1;
            ca[i*3+1] += (g - ca[i*3+1]) * 0.1;
            ca[i*3+2] += (b - ca[i*3+2]) * 0.1;
        }
        points.geometry.attributes.position.needsUpdate = true;
        points.geometry.attributes.color.needsUpdate = true;
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>
